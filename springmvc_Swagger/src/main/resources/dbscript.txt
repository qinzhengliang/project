create database seckill;
use seckill;

create table seckill(
	seckill_id BIGINT not null AUTO_INCREMENT COMMENT '商品库存ID',
	namea varchar(100) not null COMMENT '商品名称',
	numbera int not null COMMENT '库存数量',
	start_time timestamp not null COMMENT '秒杀开始时间',
	end_time timestamp not null COMMENT '秒杀结束时间',
	create_time timestamp not null default current_timestamp COMMENT '创建时间',

	PRIMARY key (seckill_id),
	key idx_start_time(start_time),
	key idx_end_time(end_time),
	key idx_create_time(create_time)
)Engine=InnoDB Auto_Increment=1000 Default charset=utf8 comment='秒杀库存表';


create table success_killed(
	seckill_id BIGINT not null,
	user_phone BIGINT not null,
	state TINYINT not null default -1,
	create_time timestamp not null,
	PRIMARY key (seckill_id,user_phone),
	key idx_create_time (create_time)
)Engine=InnoDB Default charset=utf8 comment='秒杀成功明细表';


insert into seckill(namea,numbera,start_time,end_time)
values
	('1000元秒杀iPhone6s',100,'2016-10-03 00:00:00','2016-10-04 00:00:00'),
	('500元秒杀iPad2',200,'2016-10-03 00:00:00','2016-10-04 00:00:00'),
	('300元秒杀小米4',300,'2016-10-03 00:00:00','2016-10-04 00:00:00'),
	('200元秒杀红米note',400,'2016-10-03 00:00:00','2016-10-04 00:00:00');




DELIMITER $$
DROP PROCEDURE IF EXISTS `seckill`.`execute_seckill` $$
CREATE
    /*[DEFINER = { user | CURRENT_USER }]*/
    PROCEDURE `seckill`.`execute_seckill`(in v_seckill_id bigint,
					in v_phone bigint,
					in v_kill_time timestamp,
					out r_result int)

    /*LANGUAGE SQL
    | [NOT] DETERMINISTIC
    | { CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA }
    | SQL SECURITY { DEFINER | INVOKER }
    | COMMENT 'string'*/
    BEGIN
	DECLARE insert_count int default 0;
	start TRANSACTION;
	insert IGNORE into success_killed (seckill_id, user_phone, create_time)
				values (v_seckill_id, v_phone, v_kill_time);
	SELECT ROW_COUNT() into insert_count;
	if (insert_count = 0) THEN
		ROLLBACK;
		set r_result = -1;
	ELSEIF (insert_count < 0) THEN
		ROLLBACK;
		set r_result = -2;
	else
		UPDATE seckill 
		set numbera = numbera-1
		WHERE seckill_id = v_seckill_id
		and numbera > 0
		and end_time > v_kill_time
		and start_time < v_kill_time;

		SELECT ROW_COUNT() into insert_count;

		if (insert_count = 0) THEN
			ROLLBACK;
			set r_result = 0;
		ELSEIF (insert_count < 0) THEN
			ROLLBACK;
			set r_result = -2;
		else
			commit;
			set r_result = 0;
		end if;
	end if;
    END$$

DELIMITER ;